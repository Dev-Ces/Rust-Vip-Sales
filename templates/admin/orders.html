{% extends 'base.html' %}

{% block title %}Rust VIP - Siparişler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="admin-title">Siparişler</h1>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-3">
        <div class="admin-sidebar">
            <div class="admin-user-info">
                <div class="admin-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="admin-user-details">
                    <h5>{{ current_user.username }}</h5>
                    <span class="admin-badge">Yönetici</span>
                </div>
            </div>
            
            <ul class="admin-nav">
                <li>
                    <a href="{{ url_for('admin') }}">
                        <i class="fas fa-tachometer-alt"></i> Kontrol Paneli
                    </a>
                </li>
                <li class="active">
                    <a href="{{ url_for('admin_orders') }}">
                        <i class="fas fa-shopping-cart"></i> Siparişler
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('admin_payment_settings') }}">
                        <i class="fas fa-money-bill-wave"></i> Ödeme Ayarları
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-users"></i> Kullanıcılar
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-cog"></i> Ayarlar
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('index') }}">
                        <i class="fas fa-home"></i> Siteye Dön
                    </a>
                </li>
            </ul>
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Tüm Siparişler</h3>
                
                <div class="order-filters">
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary filter-btn active" data-filter="all">Tümü</button>
                        <button type="button" class="btn btn-sm btn-outline-warning filter-btn" data-filter="pending">Bekleyen</button>
                        <button type="button" class="btn btn-sm btn-outline-success filter-btn" data-filter="completed">Tamamlanan</button>
                        <button type="button" class="btn btn-sm btn-outline-danger filter-btn" data-filter="cancelled">İptal Edilen</button>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table admin-table" id="orders-table">
                    <thead>
                        <tr>
                            <th>Sipariş No</th>
                            <th>Tarih</th>
                            <th>Kullanıcı</th>
                            <th>Steam ID</th>
                            <th>Tutar</th>
                            <th>Ödeme Yöntemi</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                            <tr class="order-row" data-status="{{ order.status }}">
                                <td>{{ order.order_number }}</td>
                                <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td>{{ order.user.username }}</td>
                                <td>{{ order.steam_id }}</td>
                                <td>{{ order.amount }} USD</td>
                                <td>{{ order.payment_method|capitalize }}</td>
                                <td>
                                    <span class="status-badge status-{{ order.status }}">
                                        {% if order.status == 'pending' %}
                                            İşleniyor
                                        {% elif order.status == 'completed' %}
                                            Tamamlandı
                                        {% elif order.status == 'cancelled' %}
                                            İptal Edildi
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-primary view-order-btn" data-order-id="{{ order.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if order.status == 'pending' %}
                                            <button type="button" class="btn btn-sm btn-success complete-order-btn" data-order-id="{{ order.id }}" data-order-number="{{ order.order_number }}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger cancel-order-btn" data-order-id="{{ order.id }}" data-order-number="{{ order.order_number }}">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if not orders %}
                <div class="no-orders text-center py-5">
                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                    <h4>Henüz sipariş bulunmuyor</h4>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Sipariş Detay Modal -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sipariş Detayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body" id="order-detail-content">
                <!-- JavaScript ile doldurulacak -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Sipariş Durum Değiştirme Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="status-modal-title">Sipariş Durumunu Değiştir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <p id="status-modal-message">Bu siparişin durumunu değiştirmek istediğinizden emin misiniz?</p>
                <form id="change-status-form" method="POST">
                    <input type="hidden" id="order-id-input" name="order_id">
                    <input type="hidden" id="status-input" name="status">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="confirm-status-change">Onayla</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .admin-title {
        color: #ff6b00;
        font-weight: bold;
        margin-bottom: 20px;
    }
    
    .admin-sidebar {
        background-color: #1e2124;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #333;
        height: 100%;
    }
    
    .admin-user-info {
        display: flex;
        align-items: center;
        padding-bottom: 20px;
        border-bottom: 1px solid #333;
        margin-bottom: 20px;
    }
    
    .admin-avatar {
        width: 50px;
        height: 50px;
        background-color: #ff6b00;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }
    
    .admin-avatar i {
        font-size: 1.5rem;
        color: white;
    }
    
    .admin-user-details h5 {
        margin: 0;
        color: white;
    }
    
    .admin-badge {
        background-color: #ff6b00;
        color: white;
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
    }
    
    .admin-nav {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .admin-nav li {
        margin-bottom: 5px;
    }
    
    .admin-nav li a {
        display: block;
        padding: 10px 15px;
        color: #ddd;
        text-decoration: none;
        border-radius: 5px;
        transition: all 0.3s;
    }
    
    .admin-nav li a:hover {
        background-color: #121416;
        color: #ff6b00;
    }
    
    .admin-nav li.active a {
        background-color: #ff6b00;
        color: white;
    }
    
    .admin-nav li a i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }
    
    .admin-card {
        background-color: #1e2124;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #333;
    }
    
    .admin-card h3 {
        color: #ff6b00;
        margin-bottom: 20px;
    }
    
    .admin-table {
        color: #fff;
    }
    
    .admin-table thead th {
        background-color: #121416;
        color: #ff6b00;
        border-color: #333;
    }
    
    .admin-table tbody tr {
        border-color: #333;
    }
    
    .admin-table tbody tr:hover {
        background-color: #121416;
    }
    
    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
    }
    
    .status-completed {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid #28a745;
    }
    
    .status-cancelled {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
    }
    
    .order-filters {
        display: flex;
        align-items: center;
    }
    
    .filter-btn {
        border-color: #333;
        color: #ddd;
    }
    
    .filter-btn:hover, .filter-btn:focus {
        background-color: #121416;
        border-color: #ff6b00;
        color: #ff6b00;
    }
    
    .filter-btn.active {
        background-color: #ff6b00;
        border-color: #ff6b00;
        color: white;
    }
    
    .modal-content {
        background-color: #1e2124;
        border: 1px solid #333;
        color: #fff;
    }
    
    .modal-header {
        border-bottom: 1px solid #333;
    }
    
    .modal-footer {
        border-top: 1px solid #333;
    }
    
    .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #333;
    }
    
    .detail-label {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filtre butonları
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Aktif sınıfını kaldır
                filterButtons.forEach(btn => btn.classList.remove('active'));
                // Tıklanan butona aktif sınıfını ekle
                this.classList.add('active');
                
                const filter = this.getAttribute('data-filter');
                filterOrders(filter);
            });
        });
        
        // Sipariş görüntüleme butonları
        const viewButtons = document.querySelectorAll('.view-order-btn');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                viewOrderDetails(orderId);
            });
        });
        
        // Sipariş tamamlama butonları
        const completeButtons = document.querySelectorAll('.complete-order-btn');
        completeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const orderNumber = this.getAttribute('data-order-number');
                showStatusChangeModal('completed', orderId, orderNumber);
            });
        });
        
        // Sipariş iptal butonları
        const cancelButtons = document.querySelectorAll('.cancel-order-btn');
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                const orderNumber = this.getAttribute('data-order-number');
                showStatusChangeModal('cancelled', orderId, orderNumber);
            });
        });
        
        // Durum değiştirme onay butonu
        document.getElementById('confirm-status-change').addEventListener('click', function() {
            document.getElementById('change-status-form').submit();
        });
    });
    
    function filterOrders(status) {
        const orderRows = document.querySelectorAll('.order-row');
        
        orderRows.forEach(row => {
            if (status === 'all' || row.getAttribute('data-status') === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function viewOrderDetails(orderId) {
        // Gerçek uygulamada burada bir AJAX isteği yapılır
        // Şimdilik örnek bir içerik gösterelim
        const orderDetailContent = document.getElementById('order-detail-content');
        
        // Örnek içerik
        orderDetailContent.innerHTML = `
            <div class="order-details">
                <div class="detail-item">
                    <div class="detail-label">Sipariş Numarası:</div>
                    <div class="detail-value">RVS-1A2B3C4D</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tarih:</div>
                    <div class="detail-value">10.06.2023 14:30</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kullanıcı:</div>
                    <div class="detail-value">user123</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">E-posta:</div>
                    <div class="detail-value">user123@example.com</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Steam ID:</div>
                    <div class="detail-value">76561198123456789</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tutar:</div>
                    <div class="detail-value">10 USD</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Ödeme Yöntemi:</div>
                    <div class="detail-value">Bitcoin</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Durum:</div>
                    <div class="detail-value">
                        <span class="status-badge status-pending">İşleniyor</span>
                    </div>
                </div>
            </div>
        `;
        
        // Modal'ı göster
        const orderDetailModal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        orderDetailModal.show();
    }
    
    function showStatusChangeModal(status, orderId, orderNumber) {
        const modal = document.getElementById('changeStatusModal');
        const title = document.getElementById('status-modal-title');
        const message = document.getElementById('status-modal-message');
        const orderIdInput = document.getElementById('order-id-input');
        const statusInput = document.getElementById('status-input');
        const form = document.getElementById('change-status-form');
        
        // Form action'ını ayarla
        form.action = `/admin/orders/${orderId}/update`;
        
        // Input değerlerini ayarla
        orderIdInput.value = orderId;
        statusInput.value = status;
        
        if (status === 'completed') {
            title.textContent = 'Siparişi Tamamla';
            message.textContent = `"${orderNumber}" numaralı siparişi tamamlamak istediğinizden emin misiniz? Bu işlem, kullanıcıya VIP yetkisi verecektir.`;
            document.getElementById('confirm-status-change').className = 'btn btn-success';
            document.getElementById('confirm-status-change').textContent = 'Tamamla';
        } else if (status === 'cancelled') {
            title.textContent = 'Siparişi İptal Et';
            message.textContent = `"${orderNumber}" numaralı siparişi iptal etmek istediğinizden emin misiniz?`;
            document.getElementById('confirm-status-change').className = 'btn btn-danger';
            document.getElementById('confirm-status-change').textContent = 'İptal Et';
        }
        
        // Modal'ı göster
        const statusModal = new bootstrap.Modal(modal);
        statusModal.show();
    }
</script>
{% endblock %}